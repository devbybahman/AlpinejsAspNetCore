@page
@model Admin.Pages.BaseInfo.Pages.Cities.Index
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "مدیریت شهرها";
    ViewData["PageName"] = "list-cities";
}

<div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6" x-data="citiesTable()" x-init="init()">
    <!-- Breadcrumb Start -->
    <div class="flex flex-wrap items-center justify-between gap-3 pb-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white/90">مدیریت شهرها</h2>
        <nav>
            <ol class="flex items-center gap-1.5 text-sm">
                <li>
                    <a class="inline-flex items-center gap-1.5 text-gray-500 hover:text-blue-600 transition dark:text-gray-400" asp-page="/Index">
                        خانه
                        <svg class="stroke-current rotate-180" width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.0765 12.667L10.2432 8.50033L6.0765 4.33366" stroke="" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </a>
                </li>
                <li class="text-gray-800 dark:text-white/90 font-medium">لیست شهرها</li>
            </ol>
        </nav>
    </div>
    <!-- Breadcrumb End -->

    <div class="col-span-12 space-y-6">
        <!-- table -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">

            <!-- Headers -->
            <div class="flex flex-col justify-between gap-5 border-b border-gray-200 px-5 py-4 sm:flex-row sm:items-center dark:border-gray-800">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white/90">بانک اطلاعاتی شهرها</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">جستجو و مدیریت شهرها</p>
                </div>
                <div class="flex gap-3">
                    <!-- reset filters -->
                    <button @@click="resetFilters()" class="hidden sm:inline-flex items-center justify-center gap-2 rounded-lg bg-gray-100 px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-200 transition dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700">
                        <svg class="fill-current" width="20" height="20" viewBox="0 0 24 24"><path d="M18.3 5.71a.9959.9959 0 00-1.41 0L12 10.59 7.11 5.7a.9959.9959 0 00-1.41 0c-.39.39-.39 1.02 0 1.41L10.59 12l-4.89 4.89c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L12 13.41l4.89 4.89c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z" /></svg>
                        حذف فیلترها
                    </button>

                    <!-- export -->
                    <div x-data="{ openExport: false }" class="relative">
                        <button @@click="openExport = !openExport" class="bg-gray-500 hover:bg-gray-600 flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition shadow-sm">
                            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M6.99578 4.08398C6.58156 4.08398 6.24578 4.41977 6.24578 4.83398V6.36733H13.7542V5.62451C13.7542 5.42154 13.672 5.22724 13.5262 5.08598L12.7107 4.29545C12.5707 4.15983 12.3835 4.08398 12.1887 4.08398H6.99578ZM15.2542 6.36902V5.62451C15.2542 5.01561 15.0074 4.43271 14.5702 4.00891L13.7547 3.21839C13.3349 2.81151 12.7733 2.58398 12.1887 2.58398H6.99578C5.75314 2.58398 4.74578 3.59134 4.74578 4.83398V6.36902C3.54391 6.41522 2.58374 7.40415 2.58374 8.61733V11.3827C2.58374 12.5959 3.54382 13.5848 4.74561 13.631V15.1665C4.74561 16.4091 5.75297 17.4165 6.99561 17.4165H13.0041C14.2467 17.4165 15.2541 16.4091 15.2541 15.1665V13.6311C16.456 13.585 17.4163 12.596 17.4163 11.3827V8.61733C17.4163 7.40414 16.4561 6.41521 15.2542 6.36902ZM4.74561 11.6217V12.1276C4.37292 12.084 4.08374 11.7671 4.08374 11.3827V8.61733C4.08374 8.20312 4.41953 7.86733 4.83374 7.86733H15.1663C15.5805 7.86733 15.9163 8.20312 15.9163 8.61733V11.3827C15.9163 11.7673 15.6269 12.0842 15.2541 12.1277V11.6217C15.2541 11.2075 14.9183 10.8717 14.5041 10.8717H5.49561C5.08139 10.8717 4.74561 11.2075 4.74561 11.6217ZM6.24561 12.3717V15.1665C6.24561 15.5807 6.58139 15.9165 6.99561 15.9165H13.0041C13.4183 15.9165 13.7541 15.5807 13.7541 15.1665V12.3717H6.24561Z" fill=""></path>
                            </svg>
                            خروجی
                            <svg class="w-4 h-4 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div x-show="openExport" @@click.outside="openExport = false" class="absolute left-0 z-50 w-48 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg dark:bg-gray-800 dark:border-gray-700" style="display: none;">
                            <div class="p-1 space-y-1">
                                <button @@click="exportCSV(); openExport = false" class="flex items-center w-full gap-2 px-3 py-2 text-sm text-gray-600 rounded-lg hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/5">
                                    <svg class="w-5 h-5 text-green-500 group-hover:text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    خروجی اکسل (CSV)

                                </button>
                                <button @@click="copyToClipboard(); openExport = false" class="flex items-center w-full gap-2 px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-white group">
                                    <svg class="w-5 h-5 text-blue-500 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    کپی در حافظه
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- create city -->
                    <a href="#" class="bg-mohtasham shadow-theme-xs hover:bg-mohtashamDark inline-flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition shadow-md">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 10H15M10 5V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        افزودن شهر
                    </a>
                </div>
            </div>

            <!-- Table Content -->
            <div class="custom-scrollbar overflow-x-auto">
                <table class="w-full min-w-[1100px] table-fixed border-collapse">
                    <thead class="bg-gray-50 dark:bg-gray-900/50">
                        <tr class="border-b border-gray-200 dark:border-gray-800 text-right">
                            <th class="w-2/12 px-4 py-4 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">نام شهر</th>
                            <th class="w-2/12 px-4 py-4 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">استان</th>
                            <th class="w-3/12 px-4 py-4 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400 text-center">انواع تحویل</th>
                            <th class="w-1/12 px-4 py-4 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400 text-center">پرداخت در محل</th>
                            <th class="w-2/12 px-4 py-4 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400 text-center">وضعیت</th>
                            <th class="w-1/12 px-4 py-4 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400 text-center">عملیات</th>
                        </tr>
                        <!-- Advanced Filters Row -->
                        <tr class="border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-white/[0.01]">
                            <td class="px-4 py-2">
                                <input type="text" x-model="filters.name" @@input.debounce.500ms="applyFilters()" placeholder="فیلتر نام..." class="w-full rounded border border-gray-300 bg-gray-50 px-3 py-1.5 text-xs focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            </td>
                            <td class="px-4 py-2 text-center">
                                <input type="text" x-model="filters.stateName" @@input.debounce.500ms="applyFilters()" placeholder="فیلتر استان..." class="w-full text-center rounded border border-gray-300 bg-gray-50 px-3 py-1.5 text-xs focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            </td>
                            <td class="px-4 py-2">
                                <select x-model="filters.delivery" @@change="applyFilters()" class="w-full text-center rounded border border-gray-300 bg-gray-50 px-3 py-1.5 text-xs focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                                    <option value="">همه روش‌ها</option>
                                    <option value="normal">عادی</option>
                                    <option value="quick">فوری</option>
                                    <option value="post">پستی</option>
                                    <option value="express">اکسپرس</option>
                                </select>
                            </td>
                            <td class="px-4 py-2">
                                <select x-model="filters.isCashDelivery" @@change="applyFilters()" class="w-full text-center rounded border border-gray-300 bg-gray-50 px-3 py-1.5 text-xs focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                                    <option value="">همه</option>
                                    <option value="true">دارد</option>
                                    <option value="false">ندارد</option>
                                </select>
                            </td>
                            <td class="px-4 py-2">
                                <select x-model="filters.isActive" @@change="applyFilters()" class="w-full text-center rounded border border-gray-300 bg-gray-50 px-3 py-1.5 text-xs focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                                    <option value="">همه وضعیت‌ها</option>
                                    <option value="true">فعال</option>
                                    <option value="false">غیرفعال</option>
                                </select>
                            </td>
                            <td class="px-4 py-2"></td>
                        </tr>
                    </thead>

                    <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                        <!-- Loading -->
                        <tr x-show="loading">
                            <td colspan="6" class="px-5 py-12 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <div class="h-5 w-5 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"></div>
                                    <span class="text-sm text-gray-500">در حال دریافت اطلاعات...</span>
                                </div>
                            </td>
                        </tr>

                        <!-- Empty State -->
                        <tr x-show="!loading && items.length === 0">
                            <td colspan="6" class="px-5 py-12 text-center text-sm text-gray-500 dark:text-gray-400">هیچ شهری با این مشخصات یافت نشد.</td>
                        </tr>

                        <!-- Rows -->
                        <template x-for="item in items" :key="item.id">
                            <tr x-show="!loading" class="hover:bg-gray-50 dark:hover:bg-gray-900/50 transition">
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="h-9 w-9 shrink-0 flex items-center justify-center rounded-lg bg-blue-50 text-blue-600 dark:bg-blue-900/20">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                        </div>
                                        <div class="font-semibold text-sm text-gray-800 dark:text-white" x-text="item.name"></div>
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-400 text-center" x-text="item.stateName"></td>
                                <td class="px-4 py-4">
                                    <div class="flex flex-wrap justify-center gap-1.5">
                                        <template x-if="item.isNormal"><span class="px-2 py-1 rounded-md text-[10px] font-bold dark:bg-gray-800 bg-blue-50 text-blue-600 ring-1 ring-blue-500/10">عادی</span></template>
                                        <template x-if="item.isQuick"><span class="px-2 py-1 rounded-md text-[10px] font-bold dark:bg-gray-800 bg-orange-50 text-orange-600 ring-1 ring-orange-500/10">فوری</span></template>
                                        <template x-if="item.isExpress"><span class="px-2 py-1 rounded-md text-[10px] font-bold dark:bg-gray-800 bg-purple-50 text-purple-600 ring-1 ring-purple-500/10">اکسپرس</span></template>
                                        <template x-if="item.isPost"><span class="px-2 py-1 rounded-md text-[10px] font-bold dark:bg-gray-800 bg-green-50 text-green-600 ring-1 ring-green-500/10">پستی</span></template>
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <span x-show="item.isCashDelivery" class="text-green-500 font-bold">✔</span>
                                    <span x-show="!item.isCashDelivery" class="text-red-400">✖</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium"
                                          :class="item.isActive ? 'bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800' : 'bg-red-50 text-red-700 border border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800'">
                                        <span class="w-1.5 h-1.5 rounded-full" :class="item.isActive ? 'bg-green-600' : 'bg-red-600'"></span>
                                        <span x-text="item.isActive ? 'فعال' : 'غیرفعال'"></span>
                                    </span>
                                </td>
                                <td class="px-4 py-4 text-center text-sm font-medium">
                                    <div class="flex items-center justify-center gap-2">

                                        <button class="text-gray-dark hover:text-blue-900 dark:text-white dark:hover:text-shadow-warning-25">
                                            <svg class="fill-current" width="21" height="21" viewBox="0 0 21 21" fill="none"
                                                 xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd"
                                                      d="M17.0911 3.53206C16.2124 2.65338 14.7878 2.65338 13.9091 3.53206L5.6074 11.8337C5.29899 12.1421 5.08687 12.5335 4.99684 12.9603L4.26177 16.445C4.20943 16.6931 4.286 16.9508 4.46529 17.1301C4.64458 17.3094 4.90232 17.3859 5.15042 17.3336L8.63507 16.5985C9.06184 16.5085 9.45324 16.2964 9.76165 15.988L18.0633 7.68631C18.942 6.80763 18.942 5.38301 18.0633 4.50433L17.0911 3.53206ZM14.9697 4.59272C15.2626 4.29982 15.7375 4.29982 16.0304 4.59272L17.0027 5.56499C17.2956 5.85788 17.2956 6.33276 17.0027 6.62565L16.1043 7.52402L14.0714 5.49109L14.9697 4.59272ZM13.0107 6.55175L6.66806 12.8944C6.56526 12.9972 6.49455 13.1277 6.46454 13.2699L5.96704 15.6283L8.32547 15.1308C8.46772 15.1008 8.59819 15.0301 8.70099 14.9273L15.0436 8.58468L13.0107 6.55175Z"
                                                      fill=""></path>
                                            </svg>
                                        </button>
                 
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex flex-col items-center justify-between border-t border-gray-200 px-5 py-4 sm:flex-row dark:border-gray-800">
                <div class="pb-3 sm:pb-0">
                    <span class="block text-sm font-medium text-gray-500 dark:text-gray-400">
                        نمایش صفحه
                        <span class="text-gray-800 dark:text-white" x-text="currentPage"></span>
                        از
                        <span class="text-gray-800 dark:text-white" x-text="totalPages || 1"></span>
                        <span class="mx-1 text-gray-400">|</span>
                        <span class="text-gray-600 text-sm font-medium text-gray-500 dark:text-gray-400 dark:text-gray-300">
                            <template x-if="totalItems > 0">
                                <span>مجموعاً</span>
                                <span class="font-medium text-gray-800 dark:text-white" x-text="totalItems"></span>
                                <span> مورد یافت شد</span>
                            </template>
                            <template x-if="totalItems === 0 && !loading">
                                <span class="text-red-500 italic">هیچ موردی یافت نشد</span>
                            </template>
                        </span>
                    </span>
                </div>

                <div class="flex w-full items-center justify-between gap-2 rounded-lg bg-gray-50 p-4 sm:w-auto sm:justify-normal sm:rounded-none sm:bg-transparent sm:p-0 dark:bg-gray-900 dark:sm:bg-transparent">
                    <button class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50 disabled:opacity-50 sm:px-4 sm:py-2 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"
                            :disabled="currentPage === 1 || loading"
                            @@click="fetchPage(currentPage - 1)">
                        قبلی
                    </button>

                    <ul class="hidden items-center gap-1 sm:flex">
                        <template x-for="n in pages()" :key="n + Math.random()">
                            <li>

                                <template x-if="n === '...'">
                                    <span class="flex h-9 w-9 items-center justify-center text-gray-500">...</span>
                                </template>
                                <template x-if="n !== '...'">
                                    <button @@click="fetchPage(n)"
                                            :class="currentPage === n ? 'bg-mohtasham shadow-theme-xs hover:bg-mohtashamDark text-white shadow-md' : 'text-gray-700 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-white/5'"
                                            class="flex h-9 w-9 items-center justify-center rounded-lg text-sm font-medium transition-colors">
                                        <span x-text="n"></span>
                                    </button>
                                </template>
                            </li>
                        </template>
                    </ul>

                    <span class="block text-sm font-medium text-gray-700 sm:hidden dark:text-gray-400">
                        صفحه <span x-text="currentPage"></span> از <span x-text="totalPages"></span>
                    </span>

                    <button class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50 disabled:opacity-50 sm:px-4 sm:py-2 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"
                            :disabled="currentPage >= totalPages || loading"
                            @@click="fetchPage(currentPage + 1)">
                        بعدی
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


@section js {
    <script>
        function citiesTable() {
            return {
                filters: { name: '', stateName: '', delivery: '', isCashDelivery: '', isActive: '' },
                currentPage: @Model.Cities.CurrentPage,
                totalPages: @Model.Cities.TotalPages,
                totalItems: @Model.Cities.TotalCount,
                //fetch data from OnGet
                items: @Html.Raw(Json.Serialize(Model.Cities.Items)),
                loading: false,
                init() {
                 
                },
                // for  1 2  .. 4 5 pagiantion button
                pages() {
                    let range = [];
                    let delta = 2;
                    let left = this.currentPage - delta;
                    let right = this.currentPage + delta + 1;
                    let rangeWithDots = [];
                    let l;

                    for (let i = 1; i <= this.totalPages; i++) {
                        if (i == 1 || i == this.totalPages || (i >= left && i < right)) {
                            range.push(i);
                        }
                    }

                    for (let i of range) {
                        if (l) {
                            if (i - l === 2) {
                                rangeWithDots.push(l + 1);
                            } else if (i - l !== 1) {
                                rangeWithDots.push('...');
                            }
                        }
                        rangeWithDots.push(i);
                        l = i;
                    }
                    return rangeWithDots;
                },

                async applyFilters() {
                    this.currentPage = 1;
                    await this.fetchPage(1);
                },

                async resetFilters() {
                    this.filters = { name: '', stateName: '', delivery: '', isCashDelivery: '', isActive: '' };
                    await this.applyFilters();
                },

                async fetchPage(page) {
                    if (page < 1 || (this.totalPages > 0 && page > this.totalPages) || page === '...') return;

                    this.loading = true; // اضافه شد

                    // smooth scroll
                    const tableElement = document.querySelector('.overflow-hidden.rounded-xl');
                    if(tableElement) {
                        window.scrollTo({
                            top: tableElement.offsetTop - 20,
                            behavior: 'smooth'
                        });
                    }

                    try {
                        const params = new URLSearchParams({
                            pageNumber: page,
                            name: this.filters.name || '',
                            stateName: this.filters.stateName || '',
                            deliveryType: this.filters.delivery || '',
                            isCashDelivery: this.filters.isCashDelivery || '',
                            isActive: this.filters.isActive || ''
                        });

                        const response = await fetch(`?handler=CitiesJson&${params.toString()}`);
                        if (!response.ok) throw new Error('Error');

                        const data = await response.json();
                        this.items = data.items;
                        this.currentPage = data.currentPage;
                        this.totalPages = data.totalPages || 1;
                        this.totalItems = data.totalItems ?? 0;
                                if (this.items.length === 0 && this.currentPage === 1) {
                                   this.totalItems = 0;
                                      this.totalPages = 0;
                                     }
                    } catch (error) {
                        console.error(error);
                    } finally {
                        this.loading = false;
                    }
                },

                async exportCSV() {
                    this.loading = true;
                    try {
                        const allItems = await this.fetchAllFilteredData();
                        if (!allItems || allItems.length === 0) return alert("داده‌ای یافت نشد!");

                        let csv = 'نام شهر,استان,پرداخت در محل,وضعیت\n';
                        allItems.forEach(i => {
                            csv += `${i.name},${i.stateName},${i.isCashDelivery ? 'دارد' : 'ندارد'},${i.isActive ? 'فعال' : 'غیرفعال'}\n`;
                        });

                        const now = new Date();
                        const dateStr = now.toLocaleDateString('fa-IR').replace(/\//g, '-');
                        const timeStr = now.getHours() + '-' + now.getMinutes();
                        const fileName = `cities-export-${dateStr}-${timeStr}.csv`;

                        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = fileName;
                        link.click();
                    } finally {
                        this.loading = false;
                    }
                },

                async copyToClipboard() {
                    this.loading = true;
                    try {
                        const allItems = await this.fetchAllFilteredData();
                        if (!allItems || allItems.length === 0) return alert("داده‌ای برای کپی وجود ندارد!");

                        let text = "نام شهر\tاستان\tپرداخت در محل\tوضعیت\n";
                        allItems.forEach(i => {
                            text += `${i.name}\t${i.stateName}\t${i.isCashDelivery ? 'دارد' : 'ندارد'}\t${i.isActive ? 'فعال' : 'غیرفعال'}\n`;
                        });

                        await navigator.clipboard.writeText(text);
                        alert("لیست کل نتایج با موفقیت در حافظه کپی شد.");
                    } catch (err) {
                        console.error('خطا در کپی:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                //request filter to backend
                async fetchAllFilteredData() {
                    const params = new URLSearchParams({
                        name: this.filters.name || '',
                        stateName: this.filters.stateName || '',
                        deliveryType: this.filters.delivery || '',
                        isCashDelivery: this.filters.isCashDelivery || '',
                        isActive: this.filters.isActive || ''
                    });
                    const response = await fetch(`?handler=ExportCities&${params.toString()}`);
                    if (!response.ok) throw new Error('Error');
                    return await response.json();
                }
            }
        }
    </script>
}